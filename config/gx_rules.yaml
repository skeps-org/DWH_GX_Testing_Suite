# ==========================================
# DATA QUALITY RULES REGISTRY
# ==========================================
# Structure: Table Name -> List of Expectations

tables:
  # ----------------------------------------
  # TABLE 1: application_to_lender
  # ----------------------------------------
  v73__application_to_lender:
    primary_key: "application_id"
    expectations:
      - name: "check_application_id_not_null"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT *
            FROM v73__application_to_lender
            WHERE application_id IS NULL;
        meta:
          severity: "critical"
          description: "Application ID must not be null"

      - name: "check_valid_auto_decision"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id, app_auto_decision
            FROM v73__application_to_lender
            WHERE app_auto_decision NOT IN ('APPROVED', 'DECLINED', 'SOFT_PENDING', 'ERROR') OR app_auto_decision IS NULL;
        meta:
          severity: "warning"
          description: "Application Auto Decision must be in set [APPROVED, DECLINED, SOFT_PENDING, ERROR]"

  # ----------------------------------------
  # TABLE 2: LOAN_DETAILS
  # ----------------------------------------
  v73__loan_details:
    primary_key: "loan_id"
    expectations:
      - name: "check_loan_id_unique"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, COUNT(*) AS cnt
            FROM v73__loan_details
            GROUP BY loan_id
            HAVING COUNT(*) > 1;
        meta:
          severity: "critical"
          description: "Loan ID must be unique"

      # SQL Test: Amount must be greater than 0
      - name: "check_positive_amount"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, amount
            FROM v73__loan_details
            WHERE amount <= 0 OR amount IS NULL;
        meta:
          severity: "critical"
          description: "Amount must be greater than 0"

      - name: "check_term_range_sql"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, term_value
            FROM v73__loan_details
            WHERE term_value < 12 OR term_value > 300;
        meta:
          severity: "critical"
          description: "Term must be between 12 and 300 months"

  # ----------------------------------------
  # TABLE 3: application_approval_to_funding 
  # ----------------------------------------
  v73__application_approval_to_funding:
    primary_key: "application_id"
    expectations:
      # COMPLEX QUERY: JOIN CHECK
      # Scenario: Verify we don't have an empty selected_offer_id for a closed loan.
      # We select the "Bad Rows" (Failures). If count > 0, the test fails.
      - name: "check_selected_offerid_loan"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atf.application_id, selected_offer_id 
            FROM v73__application_approval_to_funding AS atf
            INNER JOIN v73__loan_details AS ld
            ON atf.application_id = ld.application_id
            WHERE selected_offer_id IS NULL;
        meta:
          severity: "critical"
          description: "Selected Offer Id should not be NULL for Closed Loans"