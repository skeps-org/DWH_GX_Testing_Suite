# ==========================================
# DATA QUALITY RULES REGISTRY
# ==========================================
# Structure: Table Name -> List of Expectations

tables:
  # ----------------------------------------
  # TABLE 1: application_to_lender
  # ----------------------------------------
  v73__application_to_lender:
    primary_key: "application_id"
    expectations:
      - name: "check_application_id_not_null"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT *
            FROM v73__application_to_lender
            WHERE application_id IS NULL;
        meta:
          severity: "critical"
          description: "Application ID must not be null"

      - name: "check_valid_auto_decision"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id, app_auto_decision
            FROM v73__application_to_lender
            WHERE app_auto_decision NOT IN ('APPROVED', 'DECLINED', 'SOFT_PENDING', 'ERROR') OR app_auto_decision IS NULL;
        meta:
          severity: "warning"
          description: "Application Auto Decision must be in set [APPROVED, DECLINED, SOFT_PENDING, ERROR]"

      # Check 3: Auto Decision Logic based on Manual Review
      - name: "check_auto_decision_logic"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE ((ind_manual_review IS NULL OR ind_manual_review = 0) AND app_auto_decision = 'SOFT_PENDING')
               OR (ind_manual_review = 1 AND app_auto_decision IN ('APPROVED', 'DECLINED'));
        meta:
          severity: "warning"
          description: "Auto decision must be SOFT_PENDING if manual review, else APPROVED/DECLINED"  

      # Check 5, 7: Max Loan Amount consistency
      - name: "check_max_loan_amounts_consistency"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE max_loan_amt != LEAST(max_loan_amount_1_1, max_loan_amount_2_1, max_loan_amount_3_1, max_loan_amount_4_1)
               OR intermediate_max_loan_amt != LEAST(max_loan_amount_1_1, max_loan_amount_2_1, max_loan_amount_3_1, max_loan_amount_4_1);
        meta:
          severity: "critical"
          description: "Max loan amounts must equal the minimum of the four component amounts"

      # Check 6
      - name: "check_stated_income_max_loan_amt"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id
            FROM v73__application_to_lender
            WHERE
              (
                app_auto_decision IN ('SOFT_PENDING','APPROVED')
                AND stated_income_max_loan_amt IS NULL
              )
              OR
              stated_income_max_loan_amt != LEAST(
                max_loan_amount_1_1,
                max_loan_amount_2_1,
                max_loan_amount_3_1,
                max_loan_amount_4_1
              );
        meta:
          severity: "critical"
          description: "Stated income max loan amt must be valid"
      
      # Check 9
      - name: "check_soft_pending_requires_manual_review"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id
            FROM v73__application_to_lender
            WHERE app_auto_decision = 'SOFT_PENDING'
              AND ind_manual_review != 1;
        meta:
          severity: "critical"
          description: "Soft pending cases must have manual review flag = 1"

      # Check 10
      - name: "check_pending_checks_not_null_for_soft_pending"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id
            FROM v73__application_to_lender
            WHERE app_auto_decision = 'SOFT_PENDING'
              AND (pending_checks IS NULL OR pending_checks = '[]');
        meta:
          severity: "critical"
          description: "Pending checks must exist for soft pending cases"
      
      # Check 11, 12: Income Verification
      - name: "check_income_verification_details"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE ind_income_verification = 1 AND (income_verification_method IS NULL OR verified_income IS NULL);
        meta:
          severity: "critical"
          description: "Income verification method and verified income must exist if indicator is 1"

      # Check 15, 16: Decline Reason Integrity
      - name: "check_decline_reason_integrity"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE ((latest_status = 'DECLINED' OR app_auto_decision = 'DECLINED' OR app_final_decision = 'DECLINED') AND lender_decline_reason IS NULL)
               OR (lender_decline_reason IS NOT NULL AND lender_rejection_status IS NULL)
               OR (lender_decline_reason IS NULL AND lender_rejection_status IS NOT NULL);
        meta:
          severity: "critical"
          description: "Decline reason and rejection status must be present and synchronized for declined cases"
          
      # Check 19: Pre-funding debt calculation
      - name: "check_pre_funding_debt_calculation"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE pre_funding_debt != (monthly_debt_burden + COALESCE(other_monthly_debt_burden, 0));
        meta:
          severity: "critical"
          description: "Pre-funding debt must be the sum of monthly and other monthly debt burdens"

      # Check 20-23: Component Loan Amount Deltas
      - name: "check_loan_amount_deltas"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_to_lender
            WHERE (max_loan_amount_1_1 > max_loan_amount_1 OR max_loan_amount_1 - max_loan_amount_1_1 != pre_funding_debt + lender_adjustment_debt + active_contract_balance_merchant)
               OR (max_loan_amount_2_1 > max_loan_amount_2 OR max_loan_amount_2 - max_loan_amount_2_1 != pre_funding_debt + lender_adjustment_debt + active_contract_balance_merchant);
        meta:
          severity: "critical"
          description: "The difference between max_loan_amount and its sub-component must equal the debt sum"

      # Check 8: Maximum Available Amount Logic
      - name: "check_maximum_available_amt_vs_stated_income"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atl.application_id
            FROM data_warehouse.v73__application_to_lender AS atl
            LEFT JOIN data_warehouse.v69__application_details AS ad ON atl.application_id = ad.application_id
            WHERE CASE 
                WHEN stated_income_max_loan_amt > 50000 AND income_verification_method IS NULL THEN maximum_avl_amt != 50000
                WHEN verified_income > original_total_monthly_income*12 OR stated_income_max_loan_amt < 50000 THEN maximum_avl_amt != stated_income_max_loan_amt
                ELSE maximum_avl_amt != 50000 
            END;
        meta:
          severity: "critical"
          description: "Maximum available amount calculation issues"

      # Check 18: FICO Score Match
      - name: "check_fico_score_consistency"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atl.application_id
            FROM data_warehouse.v73__application_to_lender AS atl
            LEFT JOIN data_warehouse.v73__application_details AS ad ON atl.application_id = ad.application_id
            LEFT JOIN data_warehouse.v73__bureau_details AS bd ON atl.application_id = bd.application_id AND ad.bor_customer_id = bd.customer_id
            WHERE bor_fico != CAST(JSON_EXTRACT(bd.response_data, "$.fico") AS UNSIGNED);
        meta:
          severity: "critical"
          description: "FICO score in application table must match bureau details JSON"

      # Check 24: DTI Calculation
      - name: "check_calculated_dti"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atl.application_id
            FROM data_warehouse.v73__application_to_lender AS atl
            LEFT JOIN data_warehouse.v73__application_details_v1 AS ad ON atl.application_id = ad.application_id
            WHERE ABS(calculated_dti - (pre_funding_debt / ad.bor_monthly_income)) > 0.01;
        meta:
          severity: "critical"
          description: "Calculated DTI must equal pre_funding_debt divided by monthly_income"

  # ----------------------------------------
  # TABLE 2: LOAN_DETAILS
  # ----------------------------------------
  v73__loan_details:
    primary_key: "loan_id"
    expectations:
      - name: "check_loan_id_unique"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, COUNT(*) AS cnt
            FROM v73__loan_details
            GROUP BY loan_id
            HAVING COUNT(*) > 1;
        meta:
          severity: "critical"
          description: "Loan ID must be unique"

      # SQL Test: Amount must be greater than 0
      - name: "check_positive_amount"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, amount
            FROM v73__loan_details
            WHERE amount <= 0 OR amount IS NULL;
        meta:
          severity: "critical"
          description: "Amount must be greater than 0"

      - name: "check_term_range_sql"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT loan_id, term_value
            FROM v73__loan_details
            WHERE term_value < 12 OR term_value > 300;
        meta:
          severity: "critical"
          description: "Term must be between 12 and 300 months"

  # ----------------------------------------
  # TABLE 3: application_approval_to_funding 
  # ----------------------------------------
  v73__application_approval_to_funding:
    primary_key: "application_id"
    expectations:   
      # Check 2: Application timestamp not null
      - name: "check_application_timestamp_not_null"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id
            FROM v73__application_approval_to_funding
            WHERE application_timestamp IS NULL;
        meta:
          severity: "critical"
          description: "Application timestamp must not be null"

      # Check 4 & 5: Merchant and Store Mapping
      - name: "check_merchant_and_store_presence"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_approval_to_funding 
            WHERE merchant_id IS NULL OR store_id IS NULL
        meta:
          severity: "critical"
          description: "Merchant ID and Store ID cannot be null."
      
      # Check 6a: Contract requirements
      - name: "check_selected_offerid_contract"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_approval_to_funding 
            WHERE (contract_amt != 0 AND selected_offer_id IS NULL)
        meta:
          severity: "warning"
          description: "Active contracts must have a selected offer defined"
      
      # Check 6b: selected_offer_id should not be empty for a closed loan.
      - name: "check_selected_offerid_loan"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atf.application_id, selected_offer_id 
            FROM v73__application_approval_to_funding AS atf
            INNER JOIN v73__loan_details AS ld
            ON atf.application_id = ld.application_id
            WHERE selected_offer_id IS NULL;
        meta:
          severity: "critical"
          description: "Selected Offer Id should not be NULL for Closed Loans"
      
      # Check 7 & 8: Contract Amount and Timestamp Alignment
      - name: "check_contract_timestamp_logic"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_approval_to_funding 
            WHERE (contract_amt = 0 AND contract_timestamp IS NOT NULL)
               OR (contract_amt != 0 AND contract_timestamp IS NULL)
        meta:
          severity: "warning"
          description: "Contract timestamp presence must match the non-zero status of the contract amount."

      # Check 9: Funded Amount vs Loan Details
      - name: "check_funded_amt_vs_loan_details"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atf.application_id
            FROM data_warehouse.v73__application_approval_to_funding AS atf
            LEFT JOIN data_warehouse.v69__loan_details AS ld ON atf.application_id = ld.application_id
            WHERE (atf.total_funded_amt > atf.contract_amt)
               OR (atf.total_funded_amt != ld.amount)
               OR (atf.total_funded_amt > 0 AND ld.application_id IS NULL)
        meta:
          severity: "critical"
          description: "Total funded amount must match the primary loan detail record and stay within contract limits."

      # Check 10 & 11: Funding Timestamps vs Disbursement Records
      - name: "check_funding_timestamps_vs_disbursements"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT atf.application_id
            FROM data_warehouse.v73__application_approval_to_funding AS atf
            LEFT JOIN (
                SELECT application_id, MIN(updated_at) AS fft, MAX(updated_at) AS lft
                FROM data_warehouse.v69__pos_card_disbursement
                GROUP BY application_id
            ) AS pcd ON atf.application_id = pcd.application_id
            WHERE atf.first_funding_timestamp != pcd.fft
               OR atf.last_funding_timestamp != pcd.lft
               OR (atf.total_funded_amt > 0 AND (atf.first_funding_timestamp IS NULL OR atf.last_funding_timestamp IS NULL))
        meta:
          severity: "warning"
          description: "Aggregated funding timestamps must match the individual disbursement transaction logs."

      # Check 12 & 13: Financial Boundary Validations
      - name: "check_funding_and_void_boundaries"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id FROM v73__application_approval_to_funding 
            WHERE (total_refunded_amt < 0) 
               OR (total_refunded_amt > total_funded_amt)
               OR (voided_amt + total_funded_amt > contract_amt)
        meta:
          severity: "critical"
          description: "Total refunds must be within funded limits, and total outlays (void + funded) cannot exceed contract amount."

      # Check 16: Autopay requirements
      - name: "check_autopay_method_required_when_contract_present"
        type: "unexpected_rows_expectation"
        kwargs:
          unexpected_rows_query: |
            SELECT application_id
            FROM v73__application_approval_to_funding
            WHERE contract_amt IS NOT NULL
              AND autopay_method IS NULL;
        meta:
          severity: "critical"
          description: "Autopay method must be present when contract amount exists"